<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script>
    function terminal_write(str) {
      var textarea = document.getElementById('terminal');
      textarea.value += str
      textarea.scrollTop = textarea.scrollHeight;
    }

    function terminal_writeln(str) {
      terminal_write(str + '\n')
    }

    function inc(id){
      let input = document.getElementById(id);
      input.value = parseInt(input.value) + 10
    }

    function dec(id){
      let input = document.getElementById(id);
      input.value = parseInt(input.value) - 10
    }

    function toggleSettings(){
      let settings_container = document.getElementById("settings_container");
      if (settings_container.style.display === "block") {
        settings_container.style.display = "none";
      } else {
        settings_container.style.display = "block";
      }
    } 
  </script>
  <script src="bluetooth.js"></script>
  <script>    
    function steer(id) {
      const t0 = performance.now();
      const delay = getValue("interval");
      const channel = getChannel("steering")
      sendMotorCmd(getValue("speed")*id, channel)
      sleep(delay);
      sendMotorCmd(0, channel);
      const t1 = performance.now();
      terminal_writeln(`${t1 - t0} ms`);
    }

    function drive(id) {
      sendMotorCmd(250*id, getChannel("drive"));
    }

    function sendMotorCmd(speed, channel){
        let cmd = (speed >= 0) ? "+" : ""
        cmd += String(speed).padStart(3, '0') + channel;
        nusSendString(cmd, false);
    }

    function delay(time) {
      return new Promise(resolve => setTimeout(resolve, time));
    }

    function sleep(ms){
      const t = performance.now();
      while (performance.now() < t + ms){
      }
    }

    function getValue(id){
      return parseInt(document.getElementById(id).value);
    }

    function getChannel(name){
      return document.querySelector( 'input[name="' + name + '"]:checked').value;
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="header"><span id="cc">CIRCUIT </span><span id="cb">CUBES </span><span id="wr">REMOTE</span></div>
    <div class="left"><button id="left" ontouchstart="steer(1)" ontouchend="steer(-1)" onmousedown="steer(1)" onmouseup="steer(-1)">&larr;</button></div>
    <div class="right"><button id="right" ontouchstart="steer(-1)" ontouchend="steer(1)" onmousedown="steer(-1)" onmouseup="steer(1)">&rarr;</button></div>
    <div class="accelerate"><button id="accelerate" ontouchstart="drive(1)" ontouchend="drive(0)" onmousedown="drive(1)" onmouseup="drive(0)">&uarr;</button></div>
    <div class="reverse"><button id="reverse" ontouchstart="drive(-1)" ontouchend="drive(0)" onmousedown="drive(-1)" onmouseup="drive(0)">&darr;</button></div>
    <div class="bluetooth"><button id="clientConnectButton" onclick="connectionToggle()">Connect</button></div>
    <div class="settings"><button id="settings" onclick="toggleSettings()">Settings</button></div>
    <div class="terminal">
      <div id="settings_container">
        Steering motor runs for <input type="text" id="interval" value="80">ms<button onclick="inc('interval')" id="inc">+</button><button onclick="dec('interval')" id="dec">-</button>
        with speed <input type="text" id="speed" value="150"><button onclick="inc('speed')" id="inc">+</button><button onclick="dec('speed')" id="dec">-</button>.
        <br>
        Steering:
        <label for="steering"><input type="radio" id="steering" name="steering" value="a" />A</label>
        <label for="steering"><input type="radio" id="steering" name="steering" value="b" checked/>B</label>
        <label for="steering"><input type="radio" id="steering" name="steering" value="c" />C</label>  
        , Drive:  
        <label for="drive"><input type="radio" id="drive" name="drive" value="a" checked />A</label>
        <label for="drive"><input type="radio" id="drive" name="drive" value="b" />B</label>
        <label for="drive"><input type="radio" id="drive" name="drive" value="c" />C</label>       
        <br>
        <textarea id="terminal" rows="10" cols="40"></textarea>
      </div>
    </div>
  </div>
</body>
</html>
